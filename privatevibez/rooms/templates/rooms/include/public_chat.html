
<div id="pub_room_wrap h-25">
  <div id="broc_chat_room_messages">
    {% for msg in public_chat %}
    {% if msg.User == user %}
    <div class="text-muted d-flex justify-content-end">
        <small class="broc_chat_room_message_username font-weight-bold text-dark">{{ msg.User }}</small>
    </div>
    <div class="card card-body font-weight-normal py-2 my-1 broc_chat_room_message_text mb-4 ml-auto" style="border-radius: 13px; width: fit-content; background: #000000; color: #ffffff;">
        {{ msg.Message }}
    </div>
    {% else %}
    <div class="text-muted d-flex">
        <small class="broc_chat_room_message_username font-weight-bold text-dark">{{ msg.User }}</small>
    </div>
    <div class="card card-body font-weight-normal py-2 my-1 broc_chat_room_message_text mb-4" style="border-radius: 13px; width: fit-content; background: #9dffde;">
        {{ msg.Message }}
    </div>
    {% endif %}
    {% endfor %}

  </div>

  <form id="broc_chat_room_form" class="d-flex">
    <input type="text" name="broc_chat_room_message_field" class="form-control" style="height: 35px; font-size: 15px;" required/>
    <button type="submit" class="btn btn-primary">Send</button>
  </form>


</div>




<script>


  let protocol = "";
  if(window.location.protocol == "http:"){
      protocol = "ws";
  }else if(window.location.protocol == "https:"){
      protocol = "wss";
  }
  let broc_socket = new WebSocket('ws://' + window.location.host + '/ws/publicChat/{{ room_name }}/');
      broc_socket.onmessage = function(e) {
          var data = JSON.parse(e.data);
          var message = data.message;
          var username = data.username;
          // Add message to chat room
          if(username === "{{ user }}"){
              var message_element = document.createElement('div');
              message_element.setAttribute('class', 'card card-body font-weight-normal py-2 my-1 broc_chat_room_message_text mb-4 ml-auto');
              message_element.setAttribute('style', 'border-radius: 13px; width: fit-content; background: #000000; color: #ffffff;');
              message_element.innerHTML = message;
  
              var username_element = document.createElement('div');
              username_element.setAttribute('class', 'text-muted d-flex justify-content-end');
              var username_small = document.createElement('small');
              username_small.setAttribute('class', 'broc_chat_room_message_username font-weight-bold text-dark');
              username_small.innerHTML = username;
              username_element.appendChild(username_small);
  
              var messages_element = document.getElementById('broc_chat_room_messages');
              messages_element.appendChild(username_element);
              messages_element.appendChild(message_element);
          }else{
              var message_element = document.createElement('div');
              message_element.setAttribute('class', 'card card-body font-weight-normal py-2 my-1 broc_chat_room_message_text mb-4');
              message_element.setAttribute('style', 'border-radius: 13px; width: fit-content; background: #9dffde;');
              message_element.innerHTML = message;
  
              var username_element = document.createElement('div');
              username_element.setAttribute('class', 'text-muted d-flex');
              var username_small = document.createElement('small');
              username_small.setAttribute('class', 'broc_chat_room_message_username font-weight-bold text-dark');
              username_small.innerHTML = username;
              username_element.appendChild(username_small);
  
              var messages_element = document.getElementById('broc_chat_room_messages');
              messages_element.appendChild(username_element);
              messages_element.appendChild(message_element);
          }
  
          // Scroll to bottom
          messages_element.scrollTop = messages_element.scrollHeight;
      }
  
      // Send message
      var broc_form = document.getElementById('broc_chat_room_form');
      broc_form.addEventListener('submit', function(e) {
          e.preventDefault();
          var message_field = document.getElementsByName('broc_chat_room_message_field')[0];
          broc_socket.send(JSON.stringify({
              'message': message_field.value,
              'username': '{{ user }}'
          }));
          message_field.value = '';
          message_field.focus();
      });
      // Close WebSocket on page close
      window.onbeforeunload = function() {
          broc_socket.close();
      }
  


  function toggle_public_broc_room(){
    let element = document.getElementById("pub_room_wrap");
    if (element.style.display === "none") {
      element.style.display = "block";
      document.getElementById("pri_room_wrap").style.display = "none";
    } else {
      element.style.display = "none";
    }
  }

</script>