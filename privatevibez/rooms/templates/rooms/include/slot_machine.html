<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <style>
      /* CSS reset { */
        body,div,h1,button,p{margin:0;padding:0}
        button{font-family:inherit;font-size:inherit;font-style:inherit;font-weight:inherit}
        a:active,a:focus {outline: 0}
        /* } */
        
        body, input, select, textarea {font:18px/18px "Helvetica Neue",Helvetica,Arial,sans-serif;}
        body {
          background:#ddd url(https://subtlepatterns.com/patterns/texturetastic_gray.png);
        }
        
        h1 {
          text-align:center;
          margin-top: 20px;
          font-size: 1.75em;
          font-weight: normal;
          color: #000000;
        }


        #reel-wrapper p {
          font-size: 40px;
        }
        
        #sm {

        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#eeeeee', endColorstr='#cccccc',GradientType=0 );
        
          width: 520px;
          margin: 10px auto 20px;
          padding: 20px;
          border-radius: 50px;
        }
        
        #sm, .lever button {}
          .group, .reel, .lever {display: inline-block;}
          .group, .lever {

        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#fceabb', endColorstr='#fbdf93',GradientType=0 );
          }
        
        .group {
          border-radius: 30px;
          padding: 20px 0 20px 20px;
        }
        
          .reel {
        background: #fff;
        background: -moz-linear-gradient(top, rgba(255,255,255,1) 0%, rgba(241,241,241,1) 50%, rgba(225,225,225,1) 51%, rgba(246,246,246,1) 100%);
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(255,255,255,1)), color-stop(50%,rgba(241,241,241,1)), color-stop(51%,rgba(225,225,225,1)), color-stop(100%,rgba(246,246,246,1)));
        background: -webkit-linear-gradient(top, rgba(255,255,255,1) 0%,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);
        background: -o-linear-gradient(top, rgba(255,255,255,1) 0%,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);
        background: -ms-linear-gradient(top, rgba(255,255,255,1) 0%,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);
        background: linear-gradient(top, rgba(255,255,255,1) 0%,rgba(241,241,241,1) 50%,rgba(225,225,225,1) 51%,rgba(246,246,246,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#f6f6f6',GradientType=0 );
        
            text-align:center;
            float: left;
            padding:0 10px;
            width: 80px;
            height: 100px;
            overflow: hidden;
            margin-right: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 7px rgba(0,0,0,.3) inset, 0 0px 1px rgba(0,0,0,.2) inset;
          }
            .reel div {
              position: relative;
              top: -48px;
            }
            .reel p {
              font-weight: bold;
              height: 60px;
              margin-top: 10px;
            }
            .reel p:nth-child(1) {color:#c60}
            .reel p:nth-child(2) {color:#690}
            .reel p:nth-child(3) {color:#630}
        
        .lever {
          float: right;
          padding-right: 20px;
        }
          .lever button {
            text-align:center;
            border-radius: 10px;
            line-height: 100px;
            width: 100px;
            border: none;
            font-size:1.8em;
            -webkit-transition: all .2s ease;
            -moz-transition: all .2s ease;
            -o-transition: all .2s ease;
        background: rgb(252,255,244);
        background: -moz-linear-gradient(top, rgba(252,255,244,1) 0%, rgba(233,233,206,1) 100%);
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(252,255,244,1)), color-stop(100%,rgba(233,233,206,1)));
        background: -webkit-linear-gradient(top, rgba(252,255,244,1) 0%,rgba(233,233,206,1) 100%);
        background: -o-linear-gradient(top, rgba(252,255,244,1) 0%,rgba(233,233,206,1) 100%);
        background: -ms-linear-gradient(top, rgba(252,255,244,1) 0%,rgba(233,233,206,1) 100%);
        background: linear-gradient(top, rgba(252,255,244,1) 0%,rgba(233,233,206,1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#fcfff4', endColorstr='#e9e9ce',GradientType=0 );
          }
          .lever button:active {
            color: #900;
            box-shadow: 0 1px 4px rgba(0,0,0,.3);
            margin: 2px 0 -2px;
          }
        
        .msg {
          text-align: center;
          color: #000000;
          font-size:1.8em;
          padding: 25px 0 5px;
          text-shadow: 0 -1px 0 rgba(0,0,0,.3), 0 1px 0 rgba(255,255,255,.5);
        }
        
        a {
          color: #222cff;
          margin-top: 15px;
          text-align: center;
          display: block;
          text-decoration:none;
        }
        
        a:hover {
          color:#ff4c00
        }
    </style>
  </head>
  <body id="slot_machine_wrapper">

    <h1>Slot Machine</h1>
    <h3 class="text-center">Cost per spin <span id="cost_per_spin" class="text-center fs-2 d-inline">{{slot_machine_cost_per_spin.Slot_Machine_Spin_Cost}}</span> Vibez</h3>

  
    {% if user_datas.Vibez >= slot_machine_cost_per_spin.Slot_Machine_Spin_Cost or user_datas.Free_spins != 0 %}
<div id="sm" class="">
  <div class="group lever">
    <button id="start">Play</button>
  </div>
  <div id = "reel-wrapper" class="group">
    <div class="reel fs-2"></div>
    <div class="reel fs-2"></div>
    <div class="reel fs-2"></div>
  </div>
  <p class="msg">Press Play</p>
  <p class="fs-1 mt-3" id="slot-machine-pot">POT: <span class="fs-1" id="pot">{{slot_machine_data.pot}}</span></p>
</div>

{% else %}
<h3 class="row justify-content-center">You need more Vibez to play</h3>
{% endif %}

<div id="prize">

</div>


    <script>
      let is_pot_empty;
      
      function give_prize(prize){

        $.ajax({
          url: '/room/get_prize/',
          type: 'POST',
          data:{
              winner: {{request.user.id}},
              broadcaster: {{broadcaster_user.id}},
              pot: document.getElementById('pot').textContent,
              prize_won: prize,
              cost_per_spin: document.getElementById('cost_per_spin').innerHTML,
   
              'csrfmiddlewaretoken':"{{csrf_token}}",
          
          },
          success: function (data) {
              // Display the fetched data (example: update the DOM)
              const msg = data.data;
              console.log(msg);
              const spins = msg.spins;
              const pot = msg.pot
              const vibez = msg.vibez
 
              successToast(msg.msg);  
              
              console.log(pot);

              if(pot !== null){
                document.getElementById('pot').innerHTML = pot;
              }

              if (vibez !== null){
                document.getElementById('user_vibez').innerHTML = vibez.vibez;
              }

              if(spins !== null) {
                document.getElementById('free_spins').innerHTML = spins.spins;
              }

              
         
      
              
          },
          error: function (xhr, textStatus, errorThrown) {
              const response = JSON.parse(xhr.responseText);
              console.log(response)

              if (response.error) {
                  errorToast(response);
              }
              else{
                const pot = response.pot
                const spins = response.spins;
                const uservibez = response.vibez;
  
                console.log(pot);
                console.log(spins);
                console.log(uservibez);
            

                if (uservibez !== null) {
                document.getElementById('user_vibez').innerHTML = uservibez.vibez;    
                }

                if (spins !== null) {
                  document.getElementById('free_spins').innerHTML = spins.spins;   
                }
                else {
                  document.getElementById('free_spins').innerHTML = 0;
                }
                if (pot !== null) {
                  document.getElementById('pot').textContent = pot;   
                }
              }


              errorToast(response.msg);

       
         
              // Handle any errors that occurred during the fetch process
          },
      });
      
      }

/*
	requestAnimationFrame polyfill
*/
(function(w){
	var lastTime = 0,
		vendors = ['webkit', /*'moz',*/ 'o', 'ms'];
	for (var i = 0; i < vendors.length && !w.requestAnimationFrame; ++i){
		w.requestAnimationFrame = w[vendors[i] + 'RequestAnimationFrame'];
		w.cancelAnimationFrame = w[vendors[i] + 'CancelAnimationFrame']
			|| w[vendors[i] + 'CancelRequestAnimationFrame'];
	}

	if (!w.requestAnimationFrame)
		w.requestAnimationFrame = function(callback, element){
			var currTime = +new Date(),
				timeToCall = Math.max(0, 16 - (currTime - lastTime)),
				id = w.setTimeout(function(){ callback(currTime + timeToCall) }, timeToCall);
			lastTime = currTime + timeToCall;
			return id;
		};

	if (!w.cancelAnimationFrame)
		w.cancelAnimationFrame = function(id){
		clearTimeout(id);
	};
})(this);

/*
	Slot Machine
*/


var sm = (function(undefined){

	var tMax = 3000, // animation time, ms
		height = 210,
		speeds = [],
		r = [],
		reels = [
    ['🍉',   '🍒','🍋'],
    ['🍉',  '🍒', '🍋'],
    ['🍉', '🍒',  '🍋']
		],
		$reels, $msg,
		start;

	function init(){
		$reels = $('.reel').each(function(i, el){
			el.innerHTML = '<div><p>' + reels[i].join('</p><p>') + '</p></div><div><p>' + reels[i].join('</p><p>') + '</p></div>'
		});

		$msg = $('.msg');
      
		$('#start').click(action);
	}

  function checkpot(){
    const pot = document.getElementById('pot').innerHTML;
    is_pot_empty = (pot >= 300) ? true : false;
    return is_pot_empty;

  }
	function action(){
		if (start !== undefined) return;

    console.log(checkpot())

    
    if (checkpot() === false)
    {
      do {
        for (var i = 0; i < 3; ++i) {
          speeds[i] = Math.random() + 0.5;
          r[i] = (Math.random() * 3 | 0) * height / 3;
        }
        // Ensure that r[0], r[1], and r[2] are not equal
      } while (r[0] === r[1] && r[1] === r[2] || r[0] === r[1] || r[1] === r[2] || r[0] === r[2]);
    
  }
    else
    {
      for (var i = 0; i < 3; ++i) {
        speeds[i] = Math.random() + .5;	
        r[i] = (Math.random() * 3 | 0) * height / 3;
      }
    }
    



		$msg.html('Spinning...');
		animate();
	}

	function animate(now){
		if (!start) start = now;
		var t = now - start || 0;

		for (var i = 0; i < 3; ++i)
			$reels[i].scrollTop = (speeds[i] / tMax / 2 * (tMax - t) * (tMax - t) + r[i]) % height | 0;

		if (t < tMax)
			requestAnimationFrame(animate);
		else {
			start = undefined;
			check();
		}
	}

  function check(){ 
    
    let prize = document.getElementById("prize");

    if (r[0] === r[1] && r[1] === r[2]) {
        // Won 3 of a Kind
        $msg.html('JACKPOT!!');

        console.log("3 of a kind");

        give_prize("3OAK");
    } 
    else if (r[0] === r[1] || r[1] === r[2] || r[0] === r[2]) {
        // Won 2 of a Kind
        $msg.html('You won! 2 of a kind! Enjoy!');
    

        give_prize("2OAK");
     
        console.log("2 of a kind");
    } 
    else {
        $msg.html('Oh no! Try again');

        give_prize("Loss");
    }
}

	return {init: init}

})();

$(sm.init);


    </script>




<!--
    <script>
const csrfToken = '{{ csrf_token }}';

// Function to fetch data using AJAX POST
function fetchData(vibez) {

  $.ajax({
    url: '/room/deduct_vibez/{{slot_machine_data.Slot_cost_per_spin}}',
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
    },
    data: JSON.stringify({
        user_id: {{request.user.id}},
        cost: vibez,
    }),
    success: function (data) {
        // Display the fetched data (example: update the DOM)
        console.log(data);
    },
    error: function (xhr, textStatus, errorThrown) {
        console.error('Error fetching data:', xhr.responseText);
        // Handle any errors that occurred during the fetch process
    },
});

}

function give_prize(prize){

  $.ajax({
    url: '/room/get_prize/',
    type: 'POST',
    data:{
        winner: {{request.user.id}},
        broadcaster: {{broadcaster_user.id}},
        prize_won: prize,
        'csrfmiddlewaretoken':"{{csrf_token}}",
    
    },
    success: function (data) {
        // Display the fetched data (example: update the DOM)
        console.log(data);


        
    },
    error: function (xhr, textStatus, errorThrown) {
        console.error('Error fetching data:', xhr.responseText);
        // Handle any errors that occurred during the fetch process
    },
});

}

var winProcessed = false; 
/*
	Slot Machine
*/
$('#start').click(() => {
var sm = (function(undefined){

	var tMax = 3000, // animation time, ms
		height = 210,
		speeds = [],
		r = [],
		reels = [
			['🍉',   '🍒','🍋'],
			['🍉',  '🍒', '🍋'],
			['🍉', '🍒',  '🍋']
		],  
		$reels, $msg,
		start;

	function init(){
		$reels = $('.reel').each(function(i, el){
			el.innerHTML = '<div><p>' + reels[i].join('</p><p>') + '</p></div><div><p>' + reels[i].join('</p><p>') + '</p></div>'
		});

		$msg = $('.msg');

    $('#start').click(function () {
      if (!winProcessed) { // Check if a win has already been processed
        if (start !== undefined) return; // If animation is already running, do nothing
  
     
  
        for (var i = 0; i < 3; ++i) {
          speeds[i] = Math.random() + .5;
          r[i] = (Math.random() * 3 | 0) * height / 3;
        }
  
        $msg.html('Spinning...');
        action();
      }

      else{
        $(sm.init);
        action();
      }
    });
	}


function action(){



		if (start !== undefined) return;

		for (var i = 0; i < 3; ++i) {
			speeds[i] = Math.random() + .5;	
			r[i] = (Math.random() * 3 | 0) * height / 3;
		}

		$msg.html('Spinning...');
		animate();
	}

	function animate(now){
		if (!start) start = now;
		var t = now - start || 0;

		for (var i = 0; i < 3; ++i)
			$reels[i].scrollTop = (speeds[i] / tMax / 2 * (tMax - t) * (tMax - t) + r[i]) % height | 0;

		if (t < tMax)
			requestAnimationFrame(animate);
		else {
			start = undefined;
			check();
      $('#start').prop('disabled', false); 
		}
	}

	function check(){ 
    
    let prize = document.getElementById("prize");
   
    if (r[0] === r[1] && r[1] === r[2]) {
      //Won 3 of a Kind
      $msg.html('You won! 3 of a kind! Enjoy ' + ' Vibez');

      prize.innerHTML = "{{slot_machine_data.Win_3_of_a_kind_prize}}"
      console.log("3 of a kind")
      if (!winProcessed) {
        give_prize("OH");
        winProcessed = true; // Set the flag to true
      }

      

    } else if (r[0] === r[1] || r[1] === r[2] || r[0] === r[2]) {
      //Won 2 of a Kind
      $msg.html('You won! 2 of a kind! Enjoy ' + ' Vibez');
      console.log("2 of a kind")
      prize.innerHTML = "{{slot_machine_data.Win_2_of_a_kind_prize}}"
      
      console.log(winProcessed)
      if (!winProcessed) {
        give_prize("OHYes");
        winProcessed = true; // Set the flag to true
      }


    } else {
      $msg.html('Try again');
    }
	}

	return {init: init}

})();

$(sm.init);
});
    </script>
-->


  </body>
</html>